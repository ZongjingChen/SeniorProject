<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CustomRobot</title>
<!--    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">-->
</head>
<body>
<!--    <script type="module" src="templateFbxLoader.js"></script>-->
<!--    <script type="module" src="../src/testCompiledCode.js"></script>-->
    <script type="module">
        /**
         * Reference: https://threejs.org/examples/webgl_loader_fbx.html
         */
        import * as THREE from 'https://unpkg.com/three@0.126.1/build/three.module.js';
        import {OrbitControls} from 'https://unpkg.com/three@0.126.1/examples/jsm/controls/OrbitControls.js';
        import {FBXLoader} from 'https://unpkg.com/three@0.126.1/examples/jsm/loaders/FBXLoader.js';
        import {SkeletonUtils} from 'https://unpkg.com/three@0.126.1/examples/jsm/utils/SkeletonUtils.js'
        import Stats from 'https://unpkg.com/three@0.126.1/examples/jsm/libs/stats.module.js';
        let camera, scene, renderer, mixer, stats, human, robot;
        // const animationActions = [];
        const XBOT_MODEL_PATH = '../res/models/xbot.fbx';
        const YBOT_MODEL_PATH = '../res/models/ybot.fbx';
        const clock = new THREE.Clock();
        const loader = new FBXLoader();
        const DEG_TO_RAD = Math.PI / 180;
        const FPS = 60;
        // Three axes
        const X = new THREE.Vector3(1, 0, 0);
        const Y = new THREE.Vector3(0, 1, 0);
        const Z = new THREE.Vector3(0, 0, 1);

        /**
         * This line code of code should be generated by Compiler
         * @type {string}
         */
        const MODEL_PATH = YBOT_MODEL_PATH;


        // Some limitations of human body
        const SHOULDER_TO_ARM_RATIO_X = 0;
        const SHOULDER_TO_ARM_RATIO_Z = 0;

        // Compiler will do these check
        // const ARM_FRONT_DEGREE_MAX = 180;
        // const ARM_BACK_DEGREE_MAX = -60;
        // const ARM_OUT_DEGREE_MAX = 180;
        // const ARM_IN_DEGREE_MAX = 45;
        // const FOREARM_FRONT_DEGREE_MAX = 135;
        //
        // const HEAD_ROTATION_MAX = 90;
        // const HEAD_RISE_MAX = 80;
        // const HEAD_RISE_MIN = -45;
        //
        // const LEG_FRONT_DEGREE_MAX = 100;
        // const LEG_BACK_DEGREE_MAX = -45;


        init();

        function init() {
            const container = document.createElement( 'div' );
            document.body.appendChild( container );
            camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
            camera.position.set( 0, 150, 300 );
            scene = new THREE.Scene();
            scene.background = new THREE.Color( 0xa0a0a0 );
            // light
            const hemiLight = new THREE.HemisphereLight( 0xffffff, 0x444444 );
            hemiLight.position.set( 0, 200, 0 );
            scene.add( hemiLight );

            const dirLight = new THREE.DirectionalLight( 0xffffff );
            dirLight.position.set( 0, 200, 100 );
            dirLight.castShadow = true;
            dirLight.shadow.camera.top = 180;
            dirLight.shadow.camera.bottom = - 100;
            dirLight.shadow.camera.left = - 120;
            dirLight.shadow.camera.right = 120;
            scene.add( dirLight );
            // // ground
            // const mesh = new THREE.Mesh( new THREE.PlaneGeometry( 2000, 2000 ), new THREE.MeshPhongMaterial( { color: 0x999999, depthWrite: false } ) );
            // mesh.rotation.x = - Math.PI / 2;
            // mesh.receiveShadow = true;
            // scene.add( mesh );
            // // grid
            // const grid = new THREE.GridHelper( 2000, 20, 0x000000, 0x000000 );
            // grid.material.opacity = 0.2;
            // grid.material.transparent = true;
            // scene.add( grid );
            // renderer
            renderer = new THREE.WebGLRenderer( { antialias: true } );
            renderer.setPixelRatio( window.devicePixelRatio );
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.shadowMap.enabled = true;
            container.appendChild( renderer.domElement );
            // mouse control
            const controls = new OrbitControls( camera, renderer.domElement );
            controls.target.set( 0, 100, 0 );
            controls.update();
            window.addEventListener( 'resize', onWindowResize );
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize( window.innerWidth, window.innerHeight );
            }
            // stats
            stats = new Stats();
            container.appendChild( stats.dom );

            loader.load(MODEL_PATH, function ( object ) {
                mixer = new THREE.AnimationMixer(object);
                scene.add(object);
                robot = new Robot(object);
                robot.playAnimation();
            })

            // loader.load( XBOT_MODEL_PATH, function ( object ) {
            //     mixer = new THREE.AnimationMixer(object);
            //     scene.add(object);
            //     robot = new Robot(object);
            //     robot.playAnimation();
            // })
        }

        class Model {
            contructor(object) {
                this.object = object;
            }

            playAnimation() {

            }
        }

        class Robot {
            constructor(object){
                this.object = object;
            }

            playAnimation() {
                const skeleton = this.object.children[2].skeleton;
                const action = mixer.clipAction(this.object.animations[0]);
                console.log(action);

                // praise the sun
                // SkeletonUtils.getBoneByName("mixamorigHead", skeleton).rotation.x = -5 * DEG_TO_RAD;
                // SkeletonUtils.getBoneByName("mixamorigSpine2", skeleton).rotation.x = -15 * DEG_TO_RAD;
                // leftArm.rotation.z = 35 * DEG_TO_RAD;
                // leftArm.rotation.x = -5 * DEG_TO_RAD;
                // rightArm.rotation.z = -35 * DEG_TO_RAD;
                // rightArm.rotation.x = -5 * DEG_TO_RAD;

                // Original state
                {
                    SkeletonUtils.getBoneByName("mixamorigLeftArm", skeleton).rotation.x = -5 * DEG_TO_RAD;
                    SkeletonUtils.getBoneByName("mixamorigLeftArm", skeleton).rotation.z = -80 * DEG_TO_RAD;
                    SkeletonUtils.getBoneByName("mixamorigRightArm", skeleton).rotation.z = 80 * DEG_TO_RAD;
                    SkeletonUtils.getBoneByName("mixamorigRightArm", skeleton).rotation.x = -5 * DEG_TO_RAD;

                    SkeletonUtils.getBoneByName("mixamorigLeftHand", skeleton).rotation.z = -10 * DEG_TO_RAD;
                    SkeletonUtils.getBoneByName("mixamorigRightHand", skeleton).rotation.z = 10 * DEG_TO_RAD;

                    SkeletonUtils.getBoneByName("mixamorigLeftHandThumb1", skeleton).rotation.z = 25 * DEG_TO_RAD;
                    SkeletonUtils.getBoneByName("mixamorigRightHandThumb1", skeleton).rotation.z = -25 * DEG_TO_RAD;
                    SkeletonUtils.getBoneByName("mixamorigLeftHandThumb1", skeleton).rotation.x = -10 * DEG_TO_RAD;
                    SkeletonUtils.getBoneByName("mixamorigRightHandThumb1", skeleton).rotation.x = -10 * DEG_TO_RAD;

                    SkeletonUtils.getBoneByName("mixamorigLeftLeg", skeleton).rotation.z = -5 * DEG_TO_RAD;
                    SkeletonUtils.getBoneByName("mixamorigRightLeg", skeleton).rotation.z = 5 * DEG_TO_RAD;

                    // SkeletonUtils.getBoneByName("mixamorigHead", skeleton).rotation.x = 90 * DEG_TO_RAD;
                }

                const prefix = "mixamorig";
                const bodyParts = [
                    "Hips", "Spine", "Head",
                    "LeftArm", "LeftForeArm", "LeftHand",
                    "RightArm", "RightForeArm", "RightHand",
                    "LeftLeg", "LeftUpLeg", "LeftFoot",
                    "RightLeg", "RightUpLeg", "RightFoot"];
                animate();
                console.log(this.object);
                var delta = 0;
                function animate(){
                    requestAnimationFrame(animate);

                    /**
                     * Compiled code
                     */
                    // Checkpoint #1 demo
                    {
                        // rotateHead(45, 0, 2);
                        // raiseLeftArm(90, 2, 2);
                        // raiseLeftForeArm(90, 0, 2);
                        //
                        // rotateBody(-45, 2, 2);
                        // raiseRightUpLeg(45, 2, 2);
                        // raiseRightLeg(90, 2, 2);

                        // dance(1, 0, 5);
                        rotateBody(45, 5, 2);
                    }

                    {
                        // dance bug
                        // {
                        //     rotateHead(45, 0, 2);
                        //     riseLeftLeg(45, 0, 2);
                        //     dance(1, 2, 8);
                        //     riseRightLeg(45, 4, 6);
                        //     dance(1, 4, 6);
                        // }

                        // rotateBody(45, 0, 2);
                        // bow(45, 0, 2);
                        // rotateHead(60, 0, 3);
                        // rotateLeftFoot(30, 0, 2);
                        // rotateRightFoot(-30, 0, 2);
                        // raiseLeftForeArm(45, 0, 2);
                        // raiseRightForeArm(45, 0, 2);
                        // rotateLeftHand(30, 0, 2);
                        // rotateRightHand(30, 0, 2);

                        // raiseLeftLeg(-45, 2, 4);
                        // raiseRightLeg(45, 2, 4);
                        // raiseLeftForeArm(45, 0, 2);
                        // raiseRightForeArm(45, 0, 2);
                        // raiseLeftForeArm(-45, 2, 4);
                        // raiseRightForeArm(-45, 2, 4);
                        // raiseHead(45, 0, 2);
                        // raiseLeftUpLegLateral(45, 0, 2);
                        // raiseRightUpLegLateral(45, 0, 2);
                        // raiseLeftArmLateral(-90, 0, 2);
                        // raiseLeftArm(90, 0, 2);
                        // rotateOnAxis(SkeletonUtils.getBoneByName(prefix + "LeftShoulder", skeleton), )
                        // raiseRightArmLateral(90, 0, 2);
                        // raiseRightArm(90, 2, 4);
                        // rotateHead(-45, 0, 2);
                        // raiseLeftUpLeg(45, 0, 2);
                        // raiseRightUpLeg(45, 0, 2);
                    }

                    delta += clock.getDelta();

                    renderer.render(scene, camera);
                    mixer.update(1/60);
                    stats.update();

                }

                // Left arm rotate about its local y axis
                function raiseLeftArm(degree, startTime, duration){
                    // Decide if this action should take place
                    if(startTime <= delta && delta <= startTime + duration){
                        // Calculate the degree for arm to change
                        degree = degree / (1 + SHOULDER_TO_ARM_RATIO_X);

                        // Counter clockwise, calculate degree change for one frame
                        degree = - degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "LeftArm", skeleton), degree);

                        // Add change to shoulder to make the action more vivid.
                        rotateWorldX(SkeletonUtils.getBoneByName(prefix + "LeftShoulder", skeleton), degree * SHOULDER_TO_ARM_RATIO_X);
                        // console.log(- degree * SHOULDER_TO_ARM_RATIO_X * DEG_TO_RAD);
                    }
                }

                // Right arm rotate about its local y axis
                function raiseRightArm(degree, startTime, duration){
                    // Decide if this action should take place
                    if(startTime <= delta && delta <= startTime + duration){
                        // Calculate the degree for arm to change
                        degree = degree / (1 + SHOULDER_TO_ARM_RATIO_X);

                        // Clockwise
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "RightArm", skeleton), degree);

                        // Add change to shoulder to make the action more vivid. Counter clockwise.
                        rotateWorldX(SkeletonUtils.getBoneByName(prefix + "RightShoulder", skeleton), - degree * SHOULDER_TO_ARM_RATIO_X);
                    }
                }

                // Left arm rotate about its local z axis
                function raiseLeftArmLateral(degree, startTime, duration) {
                    // Decide if this action should take place
                    if(startTime <= delta && delta <= startTime + duration){
                        // Calculate the degree for arm to change
                        degree = degree / (1 + SHOULDER_TO_ARM_RATIO_Z);

                        // Clockwise
                        degree = degree / (FPS * duration);
                        rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "LeftArm", skeleton), degree);

                        // Add change to shoulder to make the action more vivid.
                        // rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "LeftShoulder", skeleton), degree * SHOULDER_TO_ARM_RATIO_Z);
                        rotateWorldZ(SkeletonUtils.getBoneByName(prefix + "LeftShoulder", skeleton), degree * SHOULDER_TO_ARM_RATIO_Z);
                    }
                }

                // Right arm rotate about its local z axis
                function raiseRightArmLateral(degree, startTime, duration) {
                    // Decide if this action should take place
                    if(startTime <= delta && delta <= startTime + duration){
                        // Calculate the degree for arm to change
                        degree = degree / (1 + SHOULDER_TO_ARM_RATIO_Z);

                        // CounterClockwise
                        degree = - degree / (FPS * duration);
                        rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "RightArm", skeleton), degree);

                        // Add change to shoulder to make the action more vivid.
                        // rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "RightShoulder", skeleton), degree * SHOULDER_TO_ARM_RATIO_Z);
                        rotateWorldZ(SkeletonUtils.getBoneByName(prefix + "RightShoulder", skeleton), degree * SHOULDER_TO_ARM_RATIO_Z);
                    }
                }

                // Left forearm rotate about its local y axis
                function raiseLeftForeArm(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = - degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "LeftForeArm", skeleton), degree);
                    }
                }

                // Right forearm rotate about its local y axis
                function raiseRightForeArm(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "RightForeArm", skeleton), degree);
                    }
                }

                // Rotate left hand about local x axis, positive degree indicates right rotate
                function rotateLeftHand(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "LeftHand", skeleton), degree);
                    }
                }

                // Rotate right hand about local x axis, positive degree indicates left rotate
                function rotateRightHand(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "RightHand", skeleton), degree);
                    }
                }

                // Rotate head, a positive degree will rotate head left
                function rotateHead(degree, startTime, duration) {
                    if (startTime <= delta && delta <= startTime + duration) {
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "Head", skeleton), degree);
                    }
                }

                // Raise head
                function raiseHead(degree, startTime, duration) {
                    if (startTime <= delta && delta <= startTime + duration) {
                        degree = -degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "Head", skeleton), degree);
                    }
                }

                // Spine rotate about x axis
                function bow(degree, startTime, duration) {
                    if (startTime <= delta && delta <= startTime + duration) {
                        degree = degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "Spine", skeleton), degree);
                    }
                }

                // Spine rotate about y axis, positive degree indicates left rotate
                function rotateBody(degree, startTime, duration) {
                    if (startTime <= delta && delta <= startTime + duration) {
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "Spine", skeleton), degree);
                    }
                }

                // Left up leg rotate about x axis
                function raiseLeftUpLeg(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration) {
                        // Counter clockwise
                        degree = - degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "LeftUpLeg", skeleton), degree);
                    }
                }

                // Right up leg rotate about x axis
                function raiseRightUpLeg(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration) {
                        // Counter clockwise
                        degree = - degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "RightUpLeg", skeleton), degree);
                    }
                }

                // Left leg rotate about x axis
                function raiseLeftLeg(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration) {
                        // Counter clockwise
                        degree = degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "LeftLeg", skeleton), degree);
                    }
                }

                // Right leg rotate about x axis
                function raiseRightLeg(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration) {
                        // Counter clockwise
                        degree = degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "RightLeg", skeleton), degree);
                    }
                }

                // Left up leg rotate about Z axis
                function raiseLeftUpLegLateral(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration) {
                        // Clockwise
                        degree = degree / (FPS * duration);
                        rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "LeftUpLeg", skeleton), degree);
                    }
                }

                // Right up leg rotate about Z axis
                function raiseRightUpLegLateral(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration) {
                        // Counter clockwise
                        degree = - degree / (FPS * duration);
                        rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "RightUpLeg", skeleton), degree);
                    }
                }


                // Rotate left foot about local y axis, positive degree indicates left rotate
                function rotateLeftFoot(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "LeftFoot", skeleton), degree);
                    }
                }

                // Rotate right foot about local y axis, positive degree indicates left rotate
                function rotateRightFoot(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "RightFoot", skeleton), degree);
                    }
                }

                // Begin dance. Pause when finished
                function dance(speed, startTime, duration){
                    // FIXME: when more than one dance is called, the animation cannot play
                    if (startTime <= delta && delta <= startTime + duration) {
                        if(!action.isRunning()){
                            action.timeScale = speed;
                            action.play();
                            action.fadeIn(0.4);
                            console.log("Start play")
                        }
                    }
                    else {
                        if(action.isRunning()) {
                            // action.fadeOut(1);
                            action.paused = true;
                        }
                    }
                }

                /**
                 * Let a body part rotate about its local x axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateLocalX(bodyPart, degree){
                    bodyPart.rotateOnAxis(X, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about its local y axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateLocalY(bodyPart, degree){
                    // bodyPart.rotation.y += degree * DEG_TO_RAD;
                    bodyPart.rotateOnAxis(Y, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about its local z axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateLocalZ(bodyPart, degree){
                    // bodyPart.rotation.z += degree * DEG_TO_RAD;
                    bodyPart.rotateOnAxis(Z, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about world x axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateWorldX(bodyPart, degree){
                    bodyPart.rotateOnWorldAxis(X, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about world y axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateWorldY(bodyPart, degree){
                    bodyPart.rotateOnWorldAxis(Y, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about world z axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateWorldZ(bodyPart, degree){
                    bodyPart.rotateOnWorldAxis(Z, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about an arbitrary axis
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 * @param axis
                 */
                function rotateOnAxis(bodyPart, degree, axis) {
                    bodyPart.rotateOnAxis(axis, degree * DEG_TO_RAD);
                }
            }
        }

        class Human{
            constructor(object) {
                this.object = object;
            }

            playAnimation() {
                const skeleton = this.object.children[0].skeleton;
                const action = mixer.clipAction(this.object.animations[0]);
                console.log(action);

                console.log(this.object);
                // console.log(skeleton);

                // Original state
                {
                    // SkeletonUtils.getBoneByName("mixamorig1LeftArm", skeleton).rotation.x = 90 * DEG_TO_RAD;
                    // SkeletonUtils.getBoneByName("mixamorig1RightArm", skeleton).rotation.x = 90 * DEG_TO_RAD;

                    // SkeletonUtils.getBoneByName("mixamorig1LeftHand", skeleton).rotation.x = 10 * DEG_TO_RAD;
                    // SkeletonUtils.getBoneByName("mixamorig1RightHand", skeleton).rotation.x = 10 * DEG_TO_RAD;
                }

                const prefix = "mixamorig1";
                var delta = 0;
                animate();
                function animate(){
                    requestAnimationFrame(animate);

                    /**
                     * Compiled code should be inserted here.
                     */
                    {
                        // riseLeftArm(90, 0, 2);
                    }

                    delta += clock.getDelta();

                    renderer.render(scene, camera);
                    mixer.update(clock.getDelta());
                    stats.update();
                }

                // Left arm rotate about its local z axis
                function riseLeftArm(degree, startTime, duration){
                    // Decide if this action should take place
                    if(startTime <= delta && delta <= startTime + duration){
                        // Calculate the degree for arm to change
                        degree = degree / (1 + SHOULDER_TO_ARM_RATIO_X);

                        // Clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "LeftArm", skeleton), degree);

                        // Add change to shoulder to make the action more vivid.
                        // rotateWorldX(SkeletonUtils.getBoneByName(prefix + "LeftShoulder", skeleton), degree * SHOULDER_TO_ARM_RATIO_X);
                        // console.log(- degree * SHOULDER_TO_ARM_RATIO_X * DEG_TO_RAD);
                    }
                }

                // Right arm rotate about its local y axis
                function riseRightArm(degree, startTime, duration){
                    // Decide if this action should take place
                    if(startTime <= delta && delta <= startTime + duration){
                        // Calculate the degree for arm to change
                        degree = degree / (1 + SHOULDER_TO_ARM_RATIO_X);

                        // Clockwise
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "RightArm", skeleton), degree);

                        // Add change to shoulder to make the action more vivid. Counter clockwise.
                        rotateWorldX(SkeletonUtils.getBoneByName(prefix + "RightShoulder", skeleton), - degree * SHOULDER_TO_ARM_RATIO_X);
                    }
                }

                // Left arm rotate about its local z axis
                function riseLeftArmLateral(degree, startTime, duration) {
                    // Decide if this action should take place
                    if(startTime <= delta && delta <= startTime + duration){
                        // Calculate the degree for arm to change
                        degree = degree / (1 + SHOULDER_TO_ARM_RATIO_Z);

                        // Clockwise
                        degree = degree / (FPS * duration);
                        rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "LeftArm", skeleton), degree);

                        // Add change to shoulder to make the action more vivid.
                        // rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "LeftShoulder", skeleton), degree * SHOULDER_TO_ARM_RATIO_Z);
                        rotateWorldZ(SkeletonUtils.getBoneByName(prefix + "LeftShoulder", skeleton), degree * SHOULDER_TO_ARM_RATIO_Z);
                    }
                }

                // Right arm rotate about its local z axis
                function riseRightArmLateral(degree, startTime, duration) {
                    // Decide if this action should take place
                    if(startTime <= delta && delta <= startTime + duration){
                        // Calculate the degree for arm to change
                        degree = degree / (1 + SHOULDER_TO_ARM_RATIO_Z);

                        // CounterClockwise
                        degree = - degree / (FPS * duration);
                        rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "RightArm", skeleton), degree);

                        // Add change to shoulder to make the action more vivid.
                        // rotateLocalZ(SkeletonUtils.getBoneByName(prefix + "RightShoulder", skeleton), degree * SHOULDER_TO_ARM_RATIO_Z);
                        rotateWorldZ(SkeletonUtils.getBoneByName(prefix + "RightShoulder", skeleton), degree * SHOULDER_TO_ARM_RATIO_Z);
                    }
                }

                // Left forearm rotate about its local y axis
                function riseLeftForeArm(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = - degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "LeftForeArm", skeleton), degree);
                    }
                }

                // Right forearm rotate about its local y axis
                function riseRightForeArm(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "RightForeArm", skeleton), degree);
                    }
                }

                // Rotate left hand about local x axis, positive degree indicates right rotate
                function rotateLeftHand(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "LeftHand", skeleton), degree);
                    }
                }

                // Rotate right hand about local x axis, positive degree indicates left rotate
                function rotateRightHand(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "RightHand", skeleton), degree);
                    }
                }

                // Rotate head, a positive degree will rotate head left
                function rotateHead(degree, startTime, duration) {
                    if (startTime <= delta && delta <= startTime + duration) {
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "Head", skeleton), degree);
                    }
                }

                // Rise head
                function riseHead(degree, startTime, duration) {
                    if (startTime <= delta && delta <= startTime + duration) {
                        degree = -degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "Head", skeleton), degree);
                    }
                }

                // Spine rotate about x axis
                function bow(degree, startTime, duration) {
                    if (startTime <= delta && delta <= startTime + duration) {
                        degree = degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "Spine", skeleton), degree);
                    }
                }

                // Left up leg rotate about x axis
                function riseLeftUpLeg(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration) {
                        // Counter clockwise
                        degree = - degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "LeftUpLeg", skeleton), degree);
                    }
                }

                // Right up leg rotate about x axis
                function riseRightUpLeg(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration) {
                        // Counter clockwise
                        degree = - degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "RightUpLeg", skeleton), degree);
                    }
                }

                // Left leg rotate about x axis
                function riseLeftLeg(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration) {
                        // Counter clockwise
                        degree = - degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "LeftLeg", skeleton), degree);
                    }
                }

                // Right leg rotate about x axis
                function riseRightLeg(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration) {
                        // Counter clockwise
                        degree = - degree / (FPS * duration);
                        rotateLocalX(SkeletonUtils.getBoneByName(prefix + "RightLeg", skeleton), degree);
                    }
                }

                // Rotate left foot about local y axis, positive degree indicates left rotate
                function rotateLeftFoot(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "LeftFoot", skeleton), degree);
                    }
                }

                // Rotate right foot about local y axis, positive degree indicates left rotate
                function rotateRightFoot(degree, startTime, duration) {
                    if(startTime <= delta && delta <= startTime + duration){
                        // Counter clockwise, calculate degree change for one frame
                        degree = degree / (FPS * duration);
                        rotateLocalY(SkeletonUtils.getBoneByName(prefix + "RightFoot", skeleton), degree);
                    }
                }

                // Begin dance. Pause when finished
                function dance(speed, startTime, duration){
                    // FIXME: when more than one dance is called, the animation cannot play
                    if (startTime <= delta && delta <= startTime + duration) {
                        if(!action.isRunning()){
                            action.timeScale = speed;
                            action.play();
                            action.fadeIn(0.4);
                            console.log("Start play")
                        }
                    }
                    else {
                        if(action.isRunning()) {
                            // action.fadeOut(1);
                            action.paused = true;
                        }
                    }
                }

                /**
                 * Let a body part rotate about its local x axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateLocalX(bodyPart, degree){
                    bodyPart.rotateOnAxis(X, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about its local y axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateLocalY(bodyPart, degree){
                    // bodyPart.rotation.y += degree * DEG_TO_RAD;
                    bodyPart.rotateOnAxis(Y, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about its local z axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateLocalZ(bodyPart, degree){
                    // bodyPart.rotation.z += degree * DEG_TO_RAD;
                    bodyPart.rotateOnAxis(Z, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about world x axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateWorldX(bodyPart, degree){
                    bodyPart.rotateOnWorldAxis(X, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about world y axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateWorldY(bodyPart, degree){
                    bodyPart.rotateOnWorldAxis(Y, degree * DEG_TO_RAD);
                }

                /**
                 * Let a body part rotate about world z axis for a degree
                 * @param bodyPart - body part to rotate
                 * @param degree - degree to rotate
                 */
                function rotateWorldZ(bodyPart, degree){
                    bodyPart.rotateOnWorldAxis(Z, degree * DEG_TO_RAD);
                }
            }
        }
    </script>
</body>
</html>
